{% extends 'pejapp/base.html' %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">Profil użytkownika</h2>
  <div class="row">
    <div class="col-md-4">
      <div class="card mb-4 shadow-sm">
        <div class="card-body text-center">
          <h4 class="card-title" style="color: #007bff; font-weight: bold;">
            Profil {{ user.username }}
          </h4>
          <p class="card-text">{{ user.profile.bio|default:"Brak opisu" }}</p>
          <button class="btn btn-info mt-4" type="button" data-bs-toggle="collapse" data-bs-target="#editProfile" aria-expanded="false" aria-controls="editProfile">
            Edytuj profil <i class="bi bi-caret-down-fill" id="profileIcon" style="color: gray;"></i>
          </button>
        </div>
      </div>
      <div class="collapse" id="editProfile">
        <div class="card mb-4 shadow-sm">
          <div class="card-body">
            <h3 class="card-title">Edytuj profil</h3>
            <form method="post">
              {% csrf_token %}
              <div class="form-floating mb-3">
                <input type="text" name="username" class="form-control" id="id_username" placeholder="Nazwa użytkownika" value="{{ u_form.username.value }}">
                <label for="id_username">Nazwa użytkownika</label>
              </div>
              <div class="form-floating mb-3">
                <input type="email" name="email" class="form-control" id="id_email" placeholder="Email" value="{{ u_form.email.value }}">
                <label for="id_email">Email</label>
              </div>
              <div class="form-floating mb-3">
                <textarea name="bio" class="form-control" id="id_bio" placeholder="Bio">{{ p_form.bio.value }}</textarea>
                <label for="id_bio">Bio</label>
              </div>
              <button type="submit" class="btn btn-success">Zaktualizuj</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h3 class="card-title mb-4">Twoje posty</h3>
          <form method="get" class="mb-4">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="search">Szukaj w postach</label>
                <input type="text" id="search" name="search" placeholder="Szukaj w postach" class="form-control" value="{{ request.GET.search }}">
              </div>
              <div class="col-md-3">
                <label for="start_date">Data początkowa</label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
              </div>
              <div class="col-md-3">
                <label for="end_date">Data końcowa</label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
              </div>
            </div>
            <button type="submit" class="btn btn-success">Zastosuj filtry</button>
            <a href="{% url 'profile' %}" class="btn btn-secondary">Usuń filtry</a>
          </form>
          <h4 class="mb-3">Posty z tego tygodnia</h4>
          {% for post in posts %}
            {% if post.date_posted >= start_of_week %}
              <div class="card mb-3" style="margin-bottom: 20px;">
                <div class="card-body">
                  <p class="card-text">{{ post.content }}</p>
                  <p class="card-text"><small class="text-muted">{{ post.date_posted }}</small></p>
                  <a href="{% url 'post-update' post.pk %}" class="btn btn-secondary btn-sm">Edytuj</a>
                  <a href="{% url 'post-delete' post.pk %}" class="btn btn-danger btn-sm">Usuń</a>
                </div>
              </div>
            {% endif %}
          {% endfor %}
          {% if posts|length > 0 %}
            {% for post in posts %}
              {% if post.date_posted < start_of_week %}
                <h4 class="mt-4 mb-3">Starsze posty</h4>
                <div class="accordion" id="olderPosts">
                  {% for post in posts %}
                    {% if post.date_posted < start_of_week %}
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ post.pk }}">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ post.pk }}" aria-expanded="false" aria-controls="collapse{{ post.pk }}">
                            {{ post.date_posted }}
                          </button>
                        </h2>
                        <div id="collapse{{ post.pk }}" class="accordion-collapse collapse" aria-labelledby="heading{{ post.pk }}" data-bs-parent="#olderPosts">
                          <div class="accordion-body">
                            <p class="card-text">{{ post.content }}</p>
                            <p class="card-text"><small class="text-muted">{{ post.date_posted }}</small></p>
                            <a href="{% url 'post-update' post.pk %}" class="btn btn-secondary btn-sm">Edytuj</a>
                            <a href="{% url 'post-delete' post.pk %}" class="btn btn-danger btn-sm">Usuń</a>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
                {% endif %}
            {% endfor %}
          {% endif %}
          {% if not posts %}
            <p>Brak postów do wyświetlenia.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const profileIcon = document.getElementById('profileIcon');
    const editProfile = document.getElementById('editProfile');
    editProfile.addEventListener('shown.bs.collapse', function () {
      profileIcon.classList.remove('bi-caret-down-fill');
      profileIcon.classList.add('bi-caret-up-fill');
    });
    editProfile.addEventListener('hidden.bs.collapse', function () {
      profileIcon.classList.remove('bi-caret-up-fill');
      profileIcon.classList.add('bi-caret-down-fill');
    });
  });
</script>
{% endblock %}