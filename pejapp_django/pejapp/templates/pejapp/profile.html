{% extends 'pejapp/base.html' %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">Profil użytkownika</h2>
  <div class="row">
    <div class="col-md-4">
      <div class="card mb-4 shadow-sm">
        <div class="card-body text-center">
          <h4 class="card-title" style="color: #007bff; font-weight: bold;">
            Profil {{ user.username }}
          </h4>
          <p class="card-text text-muted">{{ user.profile.bio|default:"Brak opisu" }}</p>
          <button class="btn btn-info mt-4" type="button" data-bs-toggle="collapse" data-bs-target="#editProfile" aria-expanded="false" aria-controls="editProfile">
            Edytuj profil <i class="bi bi-caret-down-fill" id="profileIcon" style="color: gray;"></i>
          </button>
        </div>
      </div>
      <div class="collapse" id="editProfile">
        <div class="card mb-4 shadow-sm">
          <div class="card-body">
            <h3 class="card-title">Edytuj profil</h3>
            <form method="post">
              {% csrf_token %}
              <div class="form-floating mb-3">
                <input type="text" name="username" class="form-control" id="id_username" placeholder="Nazwa użytkownika" value="{{ u_form.username.value }}">
                <label for="id_username">Nazwa użytkownika</label>
              </div>
              <div class="form-floating mb-3">
                <input type="email" name="email" class="form-control" id="id_email" placeholder="Email" value="{{ u_form.email.value }}">
                <label for="id_email">Email</label>
              </div>
              <div class="form-floating mb-3">
                <textarea name="bio" class="form-control" id="id_bio" placeholder="Bio">{{ p_form.bio.value }}</textarea>
                <label for="id_bio">Bio</label>
              </div>
              <button type="submit" class="btn btn-success">Zaktualizuj</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h3 class="card-title mb-4">Twoje posty</h3>
          <form method="get" class="mb-4">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="search">Szukaj w postach</label>
                <input type="text" id="search" name="search" placeholder="Szukaj w postach" class="form-control" value="{{ request.GET.search }}">
              </div>
              <div class="col-md-3">
                <label for="start_date">Data początkowa</label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
              </div>
              <div class="col-md-3">
                <label for="end_date">Data końcowa</label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
              </div>
            </div>
            <button type="submit" class="btn btn-success">Zastosuj filtry</button>
            <a href="{% url 'profile' %}" class="btn btn-secondary">Usuń filtry</a>
          </form>
          <div id="post-list">
            {% include 'pejapp/post_list.html' %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const profileIcon = document.getElementById('profileIcon');
    const editProfile = document.getElementById('editProfile');
    editProfile.addEventListener('shown.bs.collapse', function () {
      profileIcon.classList.remove('bi-caret-down-fill');
      profileIcon.classList.add('bi-caret-up-fill');
    });
    editProfile.addEventListener('hidden.bs.collapse', function () {
      profileIcon.classList.remove('bi-caret-up-fill');
      profileIcon.classList.add('bi-caret-down-fill');
    });

    const postDates = document.querySelectorAll('.post-date');
    postDates.forEach(function (dateElement) {
      const date = new Date(dateElement.getAttribute('data-date'));
      const now = new Date();
      const diff = Math.abs(now - date);
      const diffSeconds = Math.floor(diff / 1000);
      const diffMinutes = Math.floor(diff / (1000 * 60));
      const diffHours = Math.floor(diff / (1000 * 60 * 60));
      const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
      const diffWeeks = Math.floor(diff / (1000 * 60 * 60 * 24 * 7));

      let formattedDate;
      if (diffSeconds < 60) {
        formattedDate = `${diffSeconds} sekund temu`;
      } else if (diffMinutes < 60) {
        formattedDate = `${diffMinutes} minut temu`;
      } else if (diffHours < 24) {
        formattedDate = `${diffHours} godzin temu`;
      } else if (diffDays < 7) {
        formattedDate = `${diffDays} dni temu`;
      } else {
        formattedDate = date.toLocaleDateString('pl-PL', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      dateElement.textContent = formattedDate;
    });

    document.querySelectorAll('.pagination a').forEach(function (link) {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        const page = this.getAttribute('data-page');
        fetch(`?page=${page}`, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.text())
        .then(html => {
          document.getElementById('post-list').innerHTML = html;
          // Re-attach event listeners to new pagination links
          document.querySelectorAll('.pagination a').forEach(function (link) {
            link.addEventListener('click', function (e) {
              e.preventDefault();
              const page = this.getAttribute('data-page');
              fetch(`?page=${page}`, {
                headers: {
                  'X-Requested-With': 'XMLHttpRequest'
                }
              })
              .then(response => response.text())
              .then(html => {
                document.getElementById('post-list').innerHTML = html;
              });
            });
          });
        });
      });
    });
  });
</script>
{% endblock %}